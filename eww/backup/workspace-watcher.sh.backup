#!/bin/bash
env > /tmp/eww-watcher-env.$$
set -x
LOG="/tmp/workspace-watcher.log"
exec >> "$LOG" 2>&1
echo "Started at $(date)"
echo "XDG_RUNTIME_DIR=$XDG_RUNTIME_DIR"
echo "WAYLAND_DISPLAY=$WAYLAND_DISPLAY"

# Fail if hyprctl doesn't work
if ! hyprctl activeworkspace -j > /dev/null; then
  echo "‚ùå hyprctl not working ‚Äî exiting"
  exit 1
fi

# Wait for Eww
for i in {1..10}; do
  if eww ping &>/dev/null; then
    echo "‚úÖ Eww is up"
    break
  fi
  echo "‚è≥ Waiting for Eww..."
  sleep 0.2
done

# Start listening
echo "üéß Subscribing to workspace events..."
hyprctl --subscribe workspace | while read -r line; do
  echo "üì• Got workspace event: $line"
  WS=$(hyprctl activeworkspace -j | jq -r '.id' 2>/dev/null)
  echo "üî¢ Parsed workspace: $WS"
  if [[ "$WS" =~ ^[0-9]+$ ]]; then
    eww update cwwks="$WS"
    echo "‚úÖ Updated cwwks to $WS"
  else
    echo "‚ö†Ô∏è Invalid ID: $WS"
  fi
done


